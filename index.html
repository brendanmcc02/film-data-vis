<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>filmDataVis</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <canvas id="myChart" width="200" height="100"></canvas>
  <script>
    async function main() {
      const genres = await getGenres();
      const meanGenreRatings = await getMeanGenreRatings();

      const ctx = document.getElementById('myChart').getContext('2d');
      const myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: genres,
          datasets: [{
            label: 'Mean Genre Ratings',
            data: meanGenreRatings,
            backgroundColor: [
              'rgba(0, 0, 255, 0.2)'
            ],
            borderColor: [
              'rgba(0, 0, 0, 1)'
            ],
            borderWidth: 0
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });

      // returns array of clean data
      async function getData() {
        const response = await fetch('data/ratings.csv');
        const dataRaw = await response.text();

        // splitting data into rows, and removing column headers
        var data = dataRaw.split('\n').slice(1);

        // removing last row if empty
        if (data[data.length - 1] === '') {
          data.pop();
        }

        // splitting rows into columns
        for (let i = 0; i < data.length; i++) {
          let column = data[i];
          column = column.split(',');
          // concatenating title if commas are in it
          if (column[3].includes('"')) {
            column[3] = column[3].replace('"', '');
            column[3] += ",";

            let searchingEndQuotationMark = true;
            while (searchingEndQuotationMark) {
              if (column[4].includes('"')) {
                column[4] = column[4].replace('"', '');
                searchingEndQuotationMark = false;
              } else {
                column[4] += ",";
              }

              column[3] += column[4];
              column.splice(4, 1);
            }
          }
          data[i] = column;
        }

        // concatenating genres into one sub-array
        for (let i = 0; i < data.length; i++) {
          let column = data[i];
          column[9] = [column[9]];
          if (column[9][0].includes('"')) {
            column[9][0] = column[9][0].replace('"', '');

            let searchingEndQuotationMark = true;
            while (searchingEndQuotationMark) {
              if (column[10].includes('"')) {
                column[10] = column[10].replace('"', '');
                searchingEndQuotationMark = false;
              }

              column[10] = column[10].replace(' ', '');
              column[9].push(column[10]);
              column.splice(10, 1);
            }
            data[i] = column;
          }
        }

        return data;
      }

      // returns array of titles
      async function getTitles() {
        let data = await getData();
        let titles = [];

        data.forEach(row => {
          titles.push(row[3])
        });

        return titles;
      }

      // returns array of ratings
      async function getRatings() {
        let data = await getData();
        let ratings = [];

        data.forEach(row => {
          ratings.push(row[1])
        })

        return ratings;
      }

      // returns array of genres [sorted alphabetically] 
      async function getGenres() {
        let data = await getData();
        let genres = [];

        data.forEach(row => {
          for (let i = 0; i < row[9].length; i++) {
            if (!genres.includes(row[9][i])) {
              genres.push(row[9][i]);
            }
          }
        })
        
        genres = genres.sort();

        return genres;
      }

      // returns array of mean genre Ratings [genres sorted alphabetically]
      async function getMeanGenreRatings() {
        let data = await getData();
        let genres = await getGenres();
        let meanGenreRatings = [];
        let sumGenres = [];
        let quantityGenres = [];

        // initialise arrays
        for (let i = 0; i < genres.length; i++) {
          meanGenreRatings[i] = 0;
          sumGenres[i] = 0;
          quantityGenres[i] = 0;
        }

        data.forEach(row => {
          let rating = row[1];

          for (let i = 0; i < row[9].length; i++) {
            let index = genres.indexOf(row[9][i]);
            sumGenres[index] += rating;
            quantityGenres[index] += 1;
          }
        })

        for (let i = 0; i < meanGenreRatings.length; i++) {
          meanGenreRatings[i] = sumGenres[i] / quantityGenres[i];
        }

        return meanGenreRatings;
      }
    }

    main();

  </script>
</body>

</html>
