<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>filmDataVis</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <canvas id="myChart" width="400" height="200"></canvas>
  <script>
    
    const filmTitles = await getFilmTitles();
    const filmRatings = await getFilmRatings();
    
    const ctx = document.getElementById('myChart').getContext('2d');
    const myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: filmTitles,
            datasets: [{
                label: 'brendanmcc02\'s Film Ratings',
                data: filmRatings,
                backgroundColor: [
                    'rgba(255, 0, 0, 0.2)',
                    'rgba(0, 255, 0, 0.2)',
                    'rgba(0, 0, 255, 0.2)'
                ],
                borderColor: [
                    'rgba(255, 100, 100, 1)',
                    'rgba(100, 255, 100, 1)',
                    'rgba(100, 100, 255, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    async function getData() {
      const response = await fetch('data/ratingsTest.csv');
      const dataRaw = await response.text();

      // splitting data into rows, and removing column headers
      var data = dataRaw.split('\n').slice(1);

      // removing last row if empty
      if (data[data.length - 1] === '') {
        data.pop();
      }

      // splitting rows into columns
      for (let i = 0; i < data.length; i++) {
        let column = data[i];
        column = column.split(',');
        // concatenating film title if commas are in it
        if (column[3].includes('"')) {
          column[3] = column[3].replace('"', '');
          column[3] += ",";

          let searchingEndQuotationMark = true;
          while (searchingEndQuotationMark) {
            if (column[4].includes('"')) {
              column[4] = column[4].replace('"', '');
              searchingEndQuotationMark = false;
            } else {
              column[4] += ",";
            }

            column[3] += column[4];
            column.splice(4, 1);
          }
        }
        data[i] = column;
      }

      // concatenating film genres into one sub-array
      for (let i = 0; i < data.length; i++) {
        let column = data[i];
        column[9] = [column[9]];
        if (column[9][0].includes('"')) {
          column[9][0] = column[9][0].replace('"', '');

          let searchingEndQuotationMark = true;
          while (searchingEndQuotationMark) {
            if (column[10].includes('"')) {
              column[10] = column[10].replace('"', '');
              searchingEndQuotationMark = false;
            }

            column[10] = column[10].replace(' ', '');
            column[9].push(column[10]);
            column.splice(10, 1);
          }
          data[i] = column;
        }
      }

      return data;
    }

    async function getFilmTitles() {
      let data = await getData();
      let filmTitles = [];

      data.forEach(row => {
        filmTitles.push(row[3])
      });

      return filmTitles;
    }

    async function getFilmRatings() {
      let data = await getData();
      let filmRatings = [];

      data.forEach(row => {
        filmRatings.push(row[1])
      })

      return filmRatings;
    }

  </script>
</body>

</html>
